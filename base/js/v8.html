<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JS引擎是什么做了什么 | 填坑之路</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="icon.png">
    <meta name="description" content="填坑日记">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.2ecebb8b.js" as="script"><link rel="preload" href="/assets/js/2.819caa33.js" as="script"><link rel="preload" href="/assets/js/10.70c2d5c8.js" as="script"><link rel="prefetch" href="/assets/js/11.14589761.js"><link rel="prefetch" href="/assets/js/12.db448d72.js"><link rel="prefetch" href="/assets/js/13.c9a52e04.js"><link rel="prefetch" href="/assets/js/14.33903181.js"><link rel="prefetch" href="/assets/js/15.956c2b6f.js"><link rel="prefetch" href="/assets/js/16.36aea976.js"><link rel="prefetch" href="/assets/js/17.34d02037.js"><link rel="prefetch" href="/assets/js/18.68b6e486.js"><link rel="prefetch" href="/assets/js/19.dc0e3d98.js"><link rel="prefetch" href="/assets/js/20.736d2805.js"><link rel="prefetch" href="/assets/js/21.fefb785b.js"><link rel="prefetch" href="/assets/js/22.72240040.js"><link rel="prefetch" href="/assets/js/23.b053b977.js"><link rel="prefetch" href="/assets/js/3.4676ee49.js"><link rel="prefetch" href="/assets/js/4.c93f0a41.js"><link rel="prefetch" href="/assets/js/5.8f9d576f.js"><link rel="prefetch" href="/assets/js/6.53827f4d.js"><link rel="prefetch" href="/assets/js/7.92103c4b.js"><link rel="prefetch" href="/assets/js/8.97402c9c.js"><link rel="prefetch" href="/assets/js/9.474fbd81.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">填坑之路</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/base/js/define.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/base/browser/browser.html" class="nav-link">
  浏览器机制
</a></div><div class="nav-item"><a href="/base/summary/http.html" class="nav-link">
  综合素质
</a></div> <a href="https://github.com/mahalo777/mahalo777.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/base/js/define.html" class="nav-link">
  JavaScript
</a></div><div class="nav-item"><a href="/base/browser/browser.html" class="nav-link">
  浏览器机制
</a></div><div class="nav-item"><a href="/base/summary/http.html" class="nav-link">
  综合素质
</a></div> <a href="https://github.com/mahalo777/mahalo777.github.io" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/base/js/define.html" class="sidebar-link">解释型语言与编译过程</a></li><li><a href="/base/js/v8.html" aria-current="page" class="active sidebar-link">V8是如何执行JS的</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/js/v8.html#js引擎是什么做了什么" class="sidebar-link">JS引擎是什么做了什么</a></li><li class="sidebar-sub-header"><a href="/base/js/v8.html#为什么需要-javascript-引擎" class="sidebar-link">为什么需要 JavaScript 引擎</a></li><li class="sidebar-sub-header"><a href="/base/js/v8.html#热门js引擎" class="sidebar-link">热门JS引擎</a></li><li class="sidebar-sub-header"><a href="/base/js/v8.html#v8引擎介绍" class="sidebar-link">V8引擎介绍</a></li><li class="sidebar-sub-header"><a href="/base/js/v8.html#v8工作流程" class="sidebar-link">v8工作流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/js/v8.html#工作流程概括" class="sidebar-link">工作流程概括</a></li><li class="sidebar-sub-header"><a href="/base/js/v8.html#具体工作流程" class="sidebar-link">具体工作流程</a></li></ul></li><li class="sidebar-sub-header"><a href="/base/js/v8.html#参考材料" class="sidebar-link">参考材料</a></li></ul></li><li><a href="/base/js/execute.html" class="sidebar-link">从浏览器-&gt;V8-&gt;JS的执行过程</a></li><li><a href="/base/js/context.html" class="sidebar-link">执行上下文</a></li><li><a href="/base/js/contextExpand.html" class="sidebar-link">执行上下文与作用域</a></li><li><a href="/base/js/scope.html" class="sidebar-link">作用域与闭包</a></li><li><a href="/base/js/eventLoop.html" class="sidebar-link">事件循环</a></li><li><a href="/base/js/proto.html" class="sidebar-link">原型</a></li><li><a href="/base/js/this.html" class="sidebar-link">this</a></li><li><a href="/base/js/extend.html" class="sidebar-link">面向对象相关</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="js引擎是什么做了什么"><a href="#js引擎是什么做了什么" class="header-anchor">#</a> JS引擎是什么做了什么</h2> <h2 id="为什么需要-javascript-引擎"><a href="#为什么需要-javascript-引擎" class="header-anchor">#</a> 为什么需要 JavaScript 引擎</h2> <p>我们写的 JavaScript 代码直接交给浏览器或者 Node 执行时，底层的 CPU 是不认识的，也没法执行。CPU 只认识自己的指令集，指令集对应的是汇编代码。写汇编代码是一件很痛苦的事情。并且不同类型的 CPU 的指令集是不一样的，那就意味着需要给每一种 CPU 重写汇编代码。
  JavaScirpt 引擎可以将 JS 代码编译为不同 CPU(Intel, ARM 以及 MIPS 等)对应的汇编代码，这样我们就不需要去翻阅每个 CPU 的指令集手册来编写汇编代码了。当然，JavaScript 引擎的工作也不只是编译代码，它还要负责执行代码、分配内存以及垃圾回收</p> <h2 id="热门js引擎"><a href="#热门js引擎" class="header-anchor">#</a> 热门JS引擎</h2> <ul><li>V8 (Google)，用 C++编写，开放源代码，由 Google 丹麦开发，是 Google Chrome 的一部分，也用于 Node.js。</li> <li>JavaScriptCore (Apple)，开放源代码，用于 webkit 型浏览器，如 Safari ，2008 年实现了编译器和字节码解释器，升级为了 SquirrelFish。苹果内部代号为“Nitro”的 JavaScript 引擎也是基于 JavaScriptCore 引擎的。</li> <li>Rhino，由 Mozilla 基金会管理，开放源代码，完全以 Java 编写，用于 HTMLUnit</li> <li>SpiderMonkey (Mozilla)，第一款 JavaScript 引擎，早期用于 Netscape Navigator，现时用于 Mozilla Firefox。</li> <li>Chakra (JScript 引擎)，用于 Internet Explorer。</li></ul> <h2 id="v8引擎介绍"><a href="#v8引擎介绍" class="header-anchor">#</a> V8引擎介绍</h2> <p>Google V8 引擎是用 C ++编写的开源高性能 JavaScript 和 WebAssembly 引擎，它已被用于 Chrome 和 Node.js 等。可以运行在 Windows 7+，macOS 10.12+和使用 x64，IA-32，ARM 或 MIPS 处理器的 Linux 系统上。</p> <p>V8 最早被开发用以嵌入到 Google 的开源浏览器 Chrome 中，第一个版本随着第一版Chrome于 2008 年 9 月 2 日发布。但是 V8 是一个可以独立运行的模块，完全可以嵌入到任何 C ++应用程序中。著名的 Node.js( 一个异步的服务器框架，可以在服务端使用 JavaScript 写出高效的网络服务器 ) 就是基于 V8 引擎的，Couchbase, MongoDB 也使用了 V8 引擎。</p> <p>和其他 JavaScript 引擎一样，V8 会编译 / 执行 JavaScript 代码，管理内存，负责垃圾回收，与宿主语言的交互等。通过暴露宿主对象 ( 变量，函数等 ) 到 JavaScript，JavaScript 可以访问宿主环境中的对象，并在脚本中完成对宿主对象的操作。</p> <h2 id="v8工作流程"><a href="#v8工作流程" class="header-anchor">#</a> v8工作流程</h2> <p><img src="/assets/img/v81.c3b8d567.jpeg" alt="v81"></p> <p><img src="/assets/img/v82.6f485e5a.jpeg" alt="v82"></p> <h3 id="工作流程概括"><a href="#工作流程概括" class="header-anchor">#</a> 工作流程概括</h3> <p>（0）初始化基础环境；</p> <p>（1）词法分析</p> <p>（2）解析源码生成 AST 和作用域；</p> <p>（3）依据 AST 和作用域生成字节码；</p> <p>（4）解释执行字节码；</p> <p>（5）监听热点代码；</p> <p>（6）优化热点代码为二进制的机器代码；</p> <p>（7）反优化生成的二进制机器代码。</p> <h3 id="具体工作流程"><a href="#具体工作流程" class="header-anchor">#</a> 具体工作流程</h3> <ol><li><p>词法分析
scanner 是一个扫描器，用于对纯文本的 JavaScript 代码进行词法分析。它会将代码分析为 tokens</p></li> <li><p>语法分析</p> <ul><li>parser 模块可以理解为是一个解析器。解析过程是一个语法分析的过程，它会将词法分析结果 tokens 转换为抽象语法树「Abstract Syntax Tree」，同时会验证语法，如果有错误就抛出语法错误。</li> <li>预解析方案：
<ul><li>主流的 JavaScript 引擎都采用了<strong>惰性解析</strong>(Lazy Parsing)，因为源码在执行前如果全部完全解析的话，不仅会造成执行时间过长，而且会消耗更多的内存以及磁盘空间。</li> <li><strong>惰性解析就是指如果遇到并不是立即执行的函数，只会对其进行预解析(Pre-Parser)，当函数被调用时，才会对其完全解析。</strong></li> <li>预解析时，只会验证函数的语法是否有效、解析函数声明以及确定函数作用域，并不会生成 AST，这项工作由 Pre-Parser 预解析器完成</li></ul></li> <li>预解析特点：
<ul><li>预解析会跳过未被使用的代码</li> <li>不会生成 AST，会产生不带有变量引用和声明的 scopes 信息</li> <li>解析速度快</li> <li>根据规范抛出特定的错误</li></ul></li> <li>全量解析特点：
<ul><li>解析被使用的代码</li> <li>生成 AST</li> <li>构建具体的 scopes 信息，变量的引用，声明等</li> <li>抛出所有的语法错误</li></ul></li></ul></li></ol> <p>此时对应的，其实就是<strong>执行上下文</strong>的创建过程，关于执行上下文我们后续详细分析。需要区分的是，作用域与作用域链的信息是在预解析阶段就已经明确了。
同时，由于预解析的特点，JavaScript 引擎会重复执行编译和执行这两个阶段，并同时增加和删除执行上下文。所以一个上下文可能会多次被添加删除。</p> <ol start="3"><li><p>生成字节码</p> <ul><li>Ignition 是 v8 提供的一个解释器。</li> <li>负责将 AST 转换为 Bytecode，解释执行 Bytecode；同时收集 TurboFan 优化编译所需的信息，比如函数参数的类型</li></ul></li> <li><p>编译器</p></li></ol> <p>TurboFan 是 v8 引擎的编译器模块。它会利用 Ignition 收集到的信息，将字节码转换为优化的机器码，以提高代码的执行性能。</p> <ul><li>如果函数只被调用 1 次，则 Ignition 将其编译 Bytecode 就直接解释执行了。TurboFan 不会进行优化编译，因为它需要 Ignition 收集函数执行时的类型信息。这就要求函数至少需要执行 1 次，TurboFan 才有可能进行优化编译。</li> <li>如果函数被调用多次，则它有可能会被识别为热点函数，且 Ignition 收集的类型信息证明可以进行优化编译的话，这时 TurboFan 则会将 Bytecode 编译为 Optimized Machine Code（已优化的机器码），以提高代码的执行性能(Optimize)。</li></ul> <p>Ignition + TurboFan 的组合，就是字节码解释器 + JIT 编译器的黄金组合「边解释边执行」。当判断无法优化时就会触发去优化「De-optimize」操作，这些代码逻辑会重新回到 Ignition 中称为字节码。</p> <p>在这个过程中，有一个建议能够帮助我们避免去优化操作，从而提高代码执行效率。那就是不要总是改变对象类型。</p> <h2 id="参考材料"><a href="#参考材料" class="header-anchor">#</a> 参考材料</h2> <ul><li><a href="https://www.cnblogs.com/goloving/p/14322764.html" target="_blank" rel="noopener noreferrer">浅析浏览器是如何工作的<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://xiaozhuanlan.com/topic/1946507283" target="_blank" rel="noopener noreferrer">https://xiaozhuanlan.com/topic/1946507283<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/base/js/define.html" class="prev">
        解释型语言与编译过程
      </a></span> <span class="next"><a href="/base/js/execute.html">
        从浏览器-&gt;V8-&gt;JS的执行过程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2ecebb8b.js" defer></script><script src="/assets/js/2.819caa33.js" defer></script><script src="/assets/js/10.70c2d5c8.js" defer></script>
  </body>
</html>
