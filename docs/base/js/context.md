
## 执行上下文和作用域链

### 写在前面
由于网上文章杂乱，很多高赞文章甚至都是旧版本，在此整理。

### ES3 ES5 ES2018(ES9)简介
- 执行上下文在 ES3 中，包含三个部分。
  1. scope：作用域，也常常被叫做作用域链。
  2. variable object：变量对象，用于存储变量的对象。
  3. this value：this 值。
- 在 ES5 中，我们改进了命名方式，把执行上下文最初的三个部分改为下面这个样子。
  1. lexical environment：词法环境，当获取变量时使用。
  2. variable environment：变量环境，当声明变量时使用。
  3. this value：this 值。
- 在 ES2018 中，执行上下文又变成了这个样子，this 值被归入 lexical environment，但是增加了不少内容。
  1. lexical environment：词法环境，当获取变量或者 this 值时使用。
  2. variable environment：变量环境，当声明变量时使用
  3. code evaluation state：用于恢复代码执行位置。
  4. Function：执行的任务是函数时使用，表示正在被执行的函数。
  5. ScriptOrModule：执行的任务是脚本或者模块时使用，表示正在被执行的代码。
  6. Realm：使用的基础库和内置对象实例。
  7. Generator：仅生成器上下文有这个属性，表示当前生成器。


### 什么是执行上下文
当 Javascript 代码在运行的时候，它都是在执行上下文中运行。可理解为是当前代码的执行环境，且同一个函数在不同的环境中执行，会因为访问数据的不同产生不一样的结果。

分为三种：全局执行上下文、函数执行上下文、Eval函数执行上下文

### 执行上下文栈
what：执行上下文栈（Execution context stack，ECS），也叫函数调用栈(call stack)，是一种拥有LIFO（后进先出）数据结构的栈，用于存储代码执行时创建的执行上下文

why：由于JS是单线程的，每次只能做一件事情，通过这种机制，我们能够追踪到哪个函数正在执行，其他函数在调用栈中排队等待执行。

how：JS引擎第一次执行脚本时，会创建一个全局执行上下文压到栈顶，然后随着每次函数的调用都会创建一个新的执行上下文放入到栈顶中，随着函数执行完毕后被执行上下文栈顶弹出，直到回到全局的执行上下文中。

### 作用域链
对于 JavaScript来说作用域及作用域链的变量查询是通过存储在浏览器内存中的执行上下文实现的。当查找变量时，首先从当前上下文中的变量对象查找，如果没有就会往上查找父级作用域中的变量对象，最终找到全局上下文的变量对象，如果没有就报错。这样由多个执行上下文的变量对象构成的链表就叫做作用域链。
```
Scope = [AO].concat([[Scope]]);
```
但这是ES3的处理，ES5中使用outer替换了这一方法。ES5中使用outer指向父级上下文，这样我们可以沿着outer链表进行查询。从父级的词法环境、变量环境中进行查找。而且链表这一结构明显比数组更合适。

### 作用域和执行上下文有什么区别呢？
1. 作用域：作用域就是一个独立的区域，它可以让变量不会向外暴露出去。作用域最大的用处就是隔离变量。内层作用域可以访问外层作用域。作用域只是一个“地盘”，其中没有变量，要通过作用域对应的执行上下文环境来获取变量的。作用域在编译阶段就已经确定了，所以作用域是静态观念的，而执行上下文环境是动态的。
2. 执行上下文：一个作用域可能包含多个执行上下文，是JS代码的运行环境。作用域变量的查找需要依赖执行上下文的变量对象。
3. 词法环境：指相应代码块内标识符与变量值、函数值之间的关联关系的一种体现。词环境内部包含环境记录器和对外部环境的引用。环境记录器是存储变量和函数声明的实际位置，对外部环境的引用意味着可以访问父级词法环境。

块级作用域就是通过词法环境的栈结构来实现的，而变量提升是通过变量环境来实现，通过这两者的结合，JavaScript 引擎也就同时支持了变量提升和块级作用域了。这也能说明在预解析阶段，定义了作用域范围，创建了执行上下文。


### 执行上下文解释作用域链、闭包、this
[翻译文章地址](https://zhuanlan.zhihu.com/p/460213025)
以往我们只是知道各个分散的概念，并不能串联起来，这个文章从执行上下文的角度解释了各个概念的由来。强推👍🏻

### 具体执行过程参考
[执行上下文](https://juejin.cn/post/7043408377661095967)

### 更详细的介绍
[详解每种](https://zhuanlan.zhihu.com/p/459759923)

### 其他参考
[执行上下文2](https://juejin.cn/post/6844904158957404167)
[执行上下文不同版本](https://juejin.cn/post/6945240902625394718#heading-12)

